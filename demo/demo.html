<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NST & DM Project</title>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <style>
            .stream-container-height {
                min-height: 360px;
            }
        </style>
    </head>
    <body class="bg-gray-900 p-4 text-gray-200">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-100">
                Real-time Style Transfer with Depth
            </h1>

            <div
                class="flex flex-col md:flex-row items-center justify-center gap-4 mb-6"
            >
                <div
                    class="video-container w-full bg-gray-800 rounded-lg shadow-lg p-1 flex items-center justify-center stream-container-height"
                >
                    <video
                        id="webcam"
                        autoplay
                        playsinline
                        class="w-full h-auto object-contain rounded-lg"
                    ></video>
                </div>
                <div
                    class="image-container w-full bg-gray-800 rounded-lg shadow-lg p-1 flex items-center justify-center stream-container-height"
                >
                    <img
                        id="processedFeed"
                        src=""
                        alt="Processed Stream"
                        class="w-full h-auto object-contain rounded-lg"
                    />
                </div>
            </div>

            <div class="flex justify-center gap-3 my-4">
                <button
                    onclick="startStream()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                >
                    Start Stream
                </button>
                <button
                    onclick="stopStream()"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                >
                    Stop Stream
                </button>
            </div>

            <div class="flex justify-center gap-3 my-4">
                <label class="text-gray-200">
                    <input type="checkbox" id="depthOnly" class="mr-2" /> Depth
                    Map Only
                </label>
            </div>
        </div>

        <script>
            let mediaStream = null;
            let isStreaming = false;
            let ws = null;
            let sendInterval = null;
            const FPS = 30;
            const WS_URL = "wss://5000.neilf.dev/ws";

            function initWebSocket() {
                if (ws && ws.readyState === WebSocket.OPEN) return;

                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log("Connected to server");
                };

                ws.onclose = () => {
                    console.log("Disconnected from server");
                    stopStream();
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    switch (message.type) {
                        case "frame":
                            document.getElementById("processedFeed").src =
                                message.data;
                            break;
                        case "started":
                            console.log("Stream started");
                            break;
                        case "stopped":
                            console.log("Stream stopped");
                            break;
                    }
                };

                ws.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    stopStream();
                };
            }

            async function startStream() {
                try {
                    initWebSocket();
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: 480,
                            height: 360,
                        },
                    });
                    const video = document.querySelector("#webcam");
                    video.srcObject = mediaStream;

                    // Start sending frames to the server
                    isStreaming = true;
                    ws.send(
                        JSON.stringify({
                            type: "start",
                            depth_only:
                                document.querySelector("#depthOnly").checked,
                        })
                    );
                    sendInterval = setInterval(sendFrame, 1000 / FPS);

                    // Remove min-height class from containers
                    const containers = document.querySelectorAll(
                        ".video-container, .image-container"
                    );
                    for (const container of containers) {
                        container.classList.remove("stream-container-height");
                    }
                } catch (err) {
                    console.error("Error accessing webcam:", err);
                }
            }

            function stopStream() {
                // Stop sending frames
                isStreaming = false;
                if (sendInterval) {
                    clearInterval(sendInterval);
                    sendInterval = null;
                }

                // Stop the webcam
                if (mediaStream) {
                    mediaStream.getTracks().forEach((track) => track.stop());
                    document.querySelector("#webcam").srcObject = null;
                }

                // Clear the processed feed
                document.querySelector("#processedFeed").src = "";

                // Notify server
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "stop" }));
                }

                // Add min-height class to containers
                const containers = document.querySelectorAll(
                    ".video-container, .image-container"
                );
                for (const container of containers) {
                    container.classList.add("stream-container-height");
                }
            }

            async function sendFrame() {
                if (!isStreaming || !ws || ws.readyState !== WebSocket.OPEN)
                    return;

                const video = document.querySelector("#webcam");
                if (!video.videoWidth) return; // Video not ready yet

                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw video frame to canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert to base64 and send to server
                const dataURL = canvas.toDataURL("image/jpeg", 0.8);
                ws.send(
                    JSON.stringify({
                        type: "frame",
                        image: dataURL,
                        depth_only:
                            document.querySelector("#depthOnly").checked,
                    })
                );
            }

            document
                .querySelector("#depthOnly")
                .addEventListener("change", () => {
                    if (isStreaming) {
                        stopStream();
                        startStream();
                    }
                });

            window.addEventListener("beforeunload", stopStream);
        </script>
    </body>
</html>
