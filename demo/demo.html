<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NST & DM Project</title>
        <style>
            .video-container {
                display: flex;
                justify-content: space-around;
                margin: 20px 0;
                gap: 20px;
            }
            video,
            img {
                width: 480px;
                height: 360px;
                object-fit: contain;
                border: 1px solid #ccc;
            }
            .controls {
                text-align: center;
                margin: 20px 0;
            }
            button {
                padding: 10px 20px;
                margin: 0 10px;
                font-size: 16px;
                cursor: pointer;
            }
            h1 {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <h1>Real-time Style Transfer with Depth</h1>

        <div class="video-container">
            <video id="webcam" autoplay playsinline></video>
            <img id="processedFeed" src="" alt="Processed Stream" />
        </div>

        <div class="controls">
            <button onclick="startStream()">Start Stream</button>
            <button onclick="stopStream()">Stop Stream</button>
        </div>

        <script>
            let mediaStream = null;
            let isStreaming = false;
            let uploadInterval = null;
            const FPS = 30;

            async function startStream() {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: 480,
                            height: 360,
                        },
                    });
                    const video = document.getElementById("webcam");
                    video.srcObject = mediaStream;

                    // Start the server-side stream using multipart/x-mixed-replace
                    document.getElementById("processedFeed").src = "/stream";

                    // Start sending frames to the server
                    isStreaming = true;
                    uploadInterval = setInterval(uploadFrame, 1000 / FPS);
                } catch (err) {
                    console.error("Error accessing webcam:", err);
                }
            }

            function stopStream() {
                // Stop sending frames
                isStreaming = false;
                if (uploadInterval) {
                    clearInterval(uploadInterval);
                    uploadInterval = null;
                }

                // Stop the webcam
                if (mediaStream) {
                    mediaStream.getTracks().forEach((track) => track.stop());
                    document.getElementById("webcam").srcObject = null;
                }

                document.getElementById("processedFeed").src = "";

                // Notify server
                fetch("/stop_stream", { method: "POST" })
                    .then((response) => response.json())
                    .then((data) => console.log("Stream stopped:", data))
                    .catch((error) => console.error("Error:", error));
            }

            async function uploadFrame() {
                if (!isStreaming) return;

                const video = document.getElementById("webcam");
                if (!video.videoWidth) return; // Video not ready yet

                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw video frame to canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert to blob and send to server
                try {
                    const blob = await new Promise((resolve) =>
                        canvas.toBlob(resolve, "image/jpeg", 0.8)
                    );
                    const formData = new FormData();
                    formData.append("frame", blob);

                    fetch("/upload_frame", {
                        method: "POST",
                        body: formData,
                    });
                } catch (error) {
                    console.error("Error uploading frame:", error);
                }
            }
        </script>
    </body>
</html>
